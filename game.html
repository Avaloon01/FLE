<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jeu â€” Image â†’ Mot</title>
  <link rel="stylesheet" href="assets/css/styles.css">
  <script defer src="assets/js/app.js"></script>
</head>
<body>
  <header>
    <div class="nav">
      <strong>FLE Vocabulaire</strong>
      <a href="index.html">ThÃ©matiques</a>
      <a href="vocab.html">Vocabulaire</a>
      <a href="game.html">Jeu</a>
      <a href="account.html">Mon compte</a>
    </div>
  </header>
  <main class="container">
    <h1 id="title">Jeu â€” Image â†’ Mot</h1>
    <div class="grid">
      <div class="card">
        <figure id="figure"><img id="img" src="" alt="" /></figure>
        <div class="options" id="options"></div>
        <div class="options">
          <button class="btn" id="hear">ðŸ”Š Ã‰couter le mot</button>
          <button class="btn btn-ghost" id="next">Suivant</button>
        </div>
        <p class="small" id="feedback"></p>
      </div>
      <div class="card">
        <h3>Score</h3>
        <div><span id="score">0</span> correct(s)</div>
        <div class="small"><span id="attempts">0</span> tentatives</div>
      </div>
    </div>
  </main>
  <footer>FLE â€” Jeu d'association image â†’ mot</footer>
  <script>
    const { loadVocab, getParam, pickN, shuffle, say, Store } = FLEVocab;
    let current = null, theme, pool = [], score=0, attempts=0;
    async function init(){
      const all = await loadVocab();
      const th = getParam('theme') && all[getParam('theme')] ? getParam('theme') : Object.keys(all)[0];
      theme = th;
      document.getElementById('title').innerText = 'Jeu â€” ' + theme;
      pool = shuffle([...all[theme]]);
      nextItem();
      document.getElementById('hear').onclick = () => current && say(current.fr);
      document.getElementById('next').onclick = () => nextItem(true);
    }
    function nextItem(skipRecord=false){
      if(pool.length === 0){ document.getElementById('feedback').innerText = 'Fin de la sÃ©rie !'; return; }
      current = pool.pop();
      document.getElementById('img').src = current.image;
      document.getElementById('img').alt = current.fr;
      document.getElementById('feedback').innerText = '';
      const distractors = pickN(window._allChoices || [], 3).filter(x => x !== current.fr);
      const opts = shuffle([current.fr, ...distractors].slice(0,4));
      renderOptions(opts);
      if(!skipRecord){ /* do nothing */ }
    }
    function renderOptions(options){
      const box = document.getElementById('options'); box.innerHTML = '';
      options.forEach(opt => {
        const b = document.createElement('button');
        b.className = 'option';
        b.textContent = opt;
        b.onclick = () => {
          const correct = opt === current.fr;
          attempts++;
          if(correct){ score++; b.classList.add('correct'); say('Bravo !'); document.getElementById('feedback').innerText = 'âœ… Correct : ' + current.fr + ' â€” PT: ' + current.pt; }
          else { b.classList.add('wrong'); say('Essaie encore'); document.getElementById('feedback').innerText = 'âŒ Mauvaise rÃ©ponse. Câ€™Ã©tait : ' + current.fr + ' â€” PT: ' + current.pt; }
          document.getElementById('score').innerText = score;
          document.getElementById('attempts').innerText = attempts;
          Store.record(theme, correct);
          // disable all
          [...box.children].forEach(ch => ch.disabled = true);
        };
        box.appendChild(b);
      });
    }
    // Preload all choices for distractors
    (async () => {
      const all = await loadVocab();
      const th = getParam('theme') && all[getParam('theme')] ? getParam('theme') : Object.keys(all)[0];
      window._allChoices = all[th].map(x => x.fr);
      init();
    })();
  </script>
</body>
</html>
